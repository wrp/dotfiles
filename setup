#!/bin/sh

# Create symbolic links in $HOME

die() { echo "$@" >&2; exit 1; }
warn() { test -z "$NOWARN" && echo "$@" >&2; }
base=$( dirname $(realpath --relative-to=$HOME $0) )
test "$(pwd)" = "$HOME" || warn "Running from $HOME"
unset main force abort
while test $# -gt 0; do
       case $1 in
       main) main=1;;
       -f)  force=1;;
       *)   die unexpected argument: $1;;
       esac
       shift
done


cd $HOME

files='
.bash-functions
.bash-interactive-functions
.bash_profile
.bashrc
.ctags
.editrc
.gitconfig
.inputrc
.pystartup
.tmux.conf
.toprc
.vim
.vimrc
'

target() {
	local suffix
	test -n "$main" && test -e $base/$1.primary && suffix=.primary
	echo $base/$1$suffix
}

for file in $files; do
	if test -e $file && ! test -d $file; then
		if test "$(md5sum < $HOME/$file)" != \
				"$(md5sum < $(target $file))"; then
			warn "different $file"
			abort=1
		fi
	fi
done


if test -n "$abort" && test -z "$force"; then
       warn "-f to force overwrite"
       exit 1;
fi

test -n "$abort" && warn overwriting

mkdir -p $HOME/.bash-history-dir
for file in $files; do
	test "$file" -eq .git ||  ln -sf $(target $file) $file || die
done
