#!/bin/sh

# This script is invoked after GIT_EDITOR and takes the name
# of a file containing the proposed commit message as $1.
# It may change the content of the file.

. "$(dirname $0)"/common-hook-functions


main() {
	: ${MAX_GIT_WIDTH:=$(git config commit.max-message-width)}
	: ${MAX_GIT_SUMMARY:=$(git config commit.max-summary-width)}
	check_message "$@" || die
	check_words "$1" || die
	validate_trailers "$@"
	run_local_hooks "$@"
}

check_words() {
	# Ensure that each word in $1 appears in the dictionary
	local f=/usr/local/share/dict/words

	if ! test -f "$f"; then
		warn "$f does not exist; not checking words"
		return 0
	fi

	if ! sort -c "$f"; then
		warn "$f is not sorted; not checking words"
		return 0
	fi

	if ! < "$1" tr -c '[:alpha:]' ' ' | tr -s ' ' \\n | sort -u | {
		status=0
		while read word; do
			if ! look -f "$word" "$f" > /dev/null; then
				warn "$word is not a word in $f"
				status=1
			fi
		done
		test "$status" = 0
	}; then
		if test -z "$BAD_WORDS"; then
			warn "Set BAD_WORDS to allow"
			return 1
		fi
	fi >&2
}

check_message() {
	bad_end="!?."  # Characters not allowed as final char of summary

	< "$1" >&2 awk '
		/^#/ { next }
		NR==1 && match($0, "[" end "]$") {
			print "Summary should not end with any of [" end "]"
			status=1
		}
		NR==1 && length > max_summary {
			printf "Summary is %d chars too long" \
				" (max width is ${MAX_GIT_SUMMARY-%d})\n", length - max_summary, max_summary
			status=1
		}
		NR==1 && ! match($0, "^[A-Z]") {
			print "Summary should start with a capital letter"
			status=1
		}
		NR > 1 && length > max_width {
			printf "Line %d (%s...) is %d chars too long (max width is ${MAX_GIT_WIDTH-%d})\n", \
				NR - 2, substr($0, 1, 10), length - max_width, max_width
			status=1
		}
		END {exit status}

	' max_width=${MAX_GIT_WIDTH:-72} max_summary=${MAX_GIT_SUMMARY:-50} end="${bad_end}"
}

# Ensure that all required trailers are present
validate_trailers() {
	local fail
	local present_trailers=$(git interpret-trailers --parse "$1")
	for value in $(git config --get-all commit.required-trailer); do
		if ! echo "$present_trailers" |
			awk '$1 == "'"$value"'" {print $2}' FS=': ' |
			grep -q .
		then
			fail=${fail:+$fail, }$value
		fi
	done
	if test -n "$fail"; then
		die "Missing required trailers: $fail" \
			"You can add trailers to \$t, a comma separated list of k:v pairs" \
			"Disable check with: git config --unset-all commit.required-trailer" \
			;
	fi
}

main "$@"
