#!/bin/sh

# Find commits in the main branch (or the branch given in b) which
# contain the given blobs

init() {
	git-rev-parse HEAD > /dev/null || exit
	branch=${b-HEAD^0}
	fmt='%Y-%m-%d@%T'
}

process_blob() {
	test "$1" -eq 00000000 2>/dev/null && return
	printf "searching for ${1:0:8}\r" >&2
	git log --format="%<(10,trunc)%h ${1:0:8} %at %s" --find-object="$1" $branch
}


main() {
	init
	for x; do
		if test -f "$x"; then
			awk '/^index/{print substr($1,7,8)}' FS=. "$x"
		else
			echo "$x"
		fi
	done |
	awk '!a[$0]++' |
	while read b; do
		process_blob "$b"
	done \
	| sort -k 3,3n \
	| perl -MTime::Piece -pe "\$v='$fmt';"'
		printf "%-10s %-8s %-19s %s\n", "commit", "blob",
			"timestamp", "summary" if $.==1;
		s/([0-9]{9,10})/gmtime($1)->strftime($v)/e
	'
}

main "$@"
