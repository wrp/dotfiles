#!/bin/sh

. "$(dirname $0)"/common-hook-functions

valid_chars='+:a-zA-Z0-9_./-'  # Characters that are acceptable in path names
against=$(git rev-parse --verify HEAD 2>/dev/null || git hash-object -t tree /dev/null)


validate_pathnames() {
	# Reject names with non standard characters
	if invalid=$(git diff --cached --name-only --diff-filter=A -z $against |
		LC_ALL=C tr -d "\000${valid_chars}" | xxd | cut -d: -f 2- | tr -s ' ' | grep .)
	then
		die "Invalid characters in filename: $invalid"
	fi
}

check_taint() {
	test -n "$GIT_IGNORE_TAINT" && return 0
	if git diff --cached | grep --color=always -C 3 '^+.*DO NOT COMMIT'; then
		die 'The commit is tainted!!  Stubbornly refusing to commit';
	fi
}

check_mixed_indentation() {
	# Always flag mixed indentation as an error:
	# - A tab followed by a space (in the indentation area)
	# - A space followed by a tab (in the indentation area)
	# This catches the problematic cases that git diff-index doesn't handle well
	local tab=$(printf '\t')
	local mixed_tab_space="^[+]${tab}${tab}* "
	local mixed_space_tab="^[+]  *${tab}"

	if git diff --cached | grep -E "${mixed_tab_space}|${mixed_space_tab}"; then
		echo "Mixed indentation error: found both tabs and spaces in indentation" >&2
		return 1
	fi
	return 0
}

standard_whitespace_ok() {
	# Use git diff-index --check to catch standard whitespace errors
	# This honors the settings in ~/.config/git/attributes
	git diff-index --check --cached $against --
}

all_whitespace_checks() {
	check_mixed_indentation && \
	standard_whitespace_ok
}

validate_whitespace() {
	local msg='allowing all whitespace errors'
	if test -n "$ALLOW_WHITESPACE_ERRORS"; then
		warn "$msg (ALLOW_WHITESPACE_ERRORS is set)"
		return 0
	fi
	if test "$(git config apply.whitespace)" = nowarn; then
		warn "$msg (config apply.whitespace is nowarn)"
		return 0
	fi

	if ! all_whitespace_checks; then
		if git config apply.whitespace | grep -q error; then
			func=die
		else
			func=warn
		fi
		$func 'invalid whitespace' \
			'To ignore: ALLOW_WHITESPACE_ERRORS=1' \
			'To allow: git config apply.whitespace warn'
	fi
}

main() {
	validate_pathnames "$@"
	validate_whitespace "$@"
	run_local_hooks "$@"
	check_taint
}

main "$@"
